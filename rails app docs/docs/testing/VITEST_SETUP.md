# Vitest + React Testing Library Setup for Frontend Testing

This guide helps you set up Vitest and React Testing Library for testing your React components generated by the slice generator.

## 1. Install Dependencies

Add these packages to your package.json:

```bash
npm install --save-dev vitest @vitest/ui jsdom
npm install --save-dev @testing-library/react @testing-library/jest-dom @testing-library/user-event
npm install --save-dev @vitejs/plugin-react
```

## 2. Update vite.config.ts

Add test configuration to your vite.config.ts:

```typescript
/// <reference types="vitest" />
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./src/test/setup.ts'],
    css: true,
  },
})
```

## 3. Create Test Setup File

Create `app/frontend/test/setup.ts`:

```typescript
import '@testing-library/jest-dom'

// Mock IntersectionObserver
global.IntersectionObserver = class IntersectionObserver {
  constructor() {}
  observe() {}
  unobserve() {}
  disconnect() {}
}

// Mock ResizeObserver
global.ResizeObserver = class ResizeObserver {
  constructor() {}
  observe() {}
  unobserve() {}
  disconnect() {}
}

// Mock window.matchMedia
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: (query: string) => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: () => {},
    removeListener: () => {},
    addEventListener: () => {},
    removeEventListener: () => {},
    dispatchEvent: () => {},
  }),
})
```

## 4. Update package.json Scripts

Add test scripts to package.json:

```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:run": "vitest run",
    "test:coverage": "vitest run --coverage"
  }
}
```

## 5. Create Test Utilities

Create `app/frontend/test/utils.tsx`:

```typescript
import React, { ReactElement } from 'react'
import { render, RenderOptions } from '@testing-library/react'

// Custom render function that includes providers if needed
const customRender = (
  ui: ReactElement,
  options?: Omit<RenderOptions, 'wrapper'>
) => render(ui, { ...options })

export * from '@testing-library/react'
export { customRender as render }
```

## 6. Configure TypeScript

Update your tsconfig.json to include test types:

```json
{
  "compilerOptions": {
    "types": ["vitest/globals", "@testing-library/jest-dom"]
  },
  "include": [
    "app/frontend/**/*",
    "app/frontend/test/setup.ts"
  ]
}
```

## 7. Mock Inertia.js

Create `app/frontend/test/mocks/inertia.ts`:

```typescript
import { vi } from 'vitest'

export const mockInertia = {
  visit: vi.fn(),
  get: vi.fn(),
  post: vi.fn(),
  put: vi.fn(),
  patch: vi.fn(),
  delete: vi.fn(),
  reload: vi.fn(),
  replace: vi.fn(),
  remember: vi.fn(),
  restore: vi.fn(),
}

export const mockUseForm = () => ({
  data: {},
  setData: vi.fn(),
  post: vi.fn(),
  put: vi.fn(),
  patch: vi.fn(),
  delete: vi.fn(),
  get: vi.fn(),
  processing: false,
  errors: {},
  hasErrors: false,
  progress: null,
  wasSuccessful: false,
  recentlySuccessful: false,
  transform: vi.fn(),
  setDefaults: vi.fn(),
  reset: vi.fn(),
  clearErrors: vi.fn(),
  setError: vi.fn(),
  submit: vi.fn(),
  cancel: vi.fn(),
})
```

## 8. Example Test Structure

Your test files should follow this pattern:

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { render, screen, fireEvent } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import YourComponent from '../YourComponent'

// Mock Inertia
vi.mock('@inertiajs/react', () => ({
  Head: ({ title }: { title: string }) => <title>{title}</title>,
  Link: ({ href, children }: any) => <a href={href}>{children}</a>,
  useForm: () => mockUseForm(),
}))

describe('YourComponent', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  it('renders correctly', () => {
    render(<YourComponent />)
    expect(screen.getByText('Expected Text')).toBeInTheDocument()
  })
})
```

## 9. Running Tests

```bash
# Run tests in watch mode
npm run test

# Run tests once
npm run test:run

# Run tests with UI
npm run test:ui

# Run tests with coverage
npm run test:coverage
```

## 10. Coverage Configuration

Add coverage configuration to vite.config.ts:

```typescript
export default defineConfig({
  test: {
    coverage: {
      provider: 'v8',
      reporter: ['text', 'html', 'json'],
      reportsDirectory: './coverage',
      exclude: [
        'node_modules/',
        'app/frontend/test/',
        '**/*.d.ts',
        '**/*.config.*',
      ],
    },
  },
})
```

## 11. CI/CD Integration

The frontend tests are automatically run in the CI/CD pipeline via GitHub Actions.

### CI Configuration

The `.github/workflows/ci.yml` includes a `test_frontend` job that:

1. Sets up Node.js using the version from `.node-version`
2. Installs dependencies with `npm ci`
3. Runs tests with `npm run test:run`
4. Generates coverage reports
5. Uploads coverage artifacts

```yaml
test_frontend:
  runs-on: ubuntu-latest
  steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version-file: .node-version
        cache: npm

    - name: Install dependencies
      run: npm ci

    - name: Run frontend tests
      run: npm run test:run

    - name: Generate coverage report
      run: npm run test:coverage
      continue-on-error: true

    - name: Upload coverage reports
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: frontend-coverage
        path: app/frontend/coverage
        if-no-files-found: ignore
```

### Running Locally

```bash
# Run tests in watch mode
npm run test

# Run tests once (as CI does)
npm run test:run

# Run tests with UI
npm run test:ui

# Run tests with coverage
npm run test:coverage
```

### Current Test Coverage

- ✅ **FlashMessages Component** - 10/10 tests passing
- ✅ **UserManagement/Users/New Page** - 12/12 tests passing
- **Total: 22/22 tests passing (100%)**

## 12. VSCode Integration

Install the Vitest extension for VSCode to run tests directly in your editor.

## 13. Best Practices

- Keep tests close to components (`__tests__` folders)
- Use descriptive test names
- Test user interactions, not implementation details
- Mock external dependencies
- Use data-testid for complex queries
- Test accessibility features
- Keep tests fast and isolated

## Common Issues

1. **Tailwind CSS classes not working in tests**: Import your CSS in the setup file
2. **Inertia components not rendering**: Make sure to mock all Inertia exports
3. **TypeScript errors**: Ensure all types are properly imported and configured
