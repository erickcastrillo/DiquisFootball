# AI Module Architecture Diagram

## High-Level Architecture

```
???????????????????????????????????????????????????????????????????
?                      Consuming Projects                         ?
?  ???????????????????              ????????????????????????      ?
?  ?  Diquis.WebApi  ?              ? Diquis.BackgroundJobs?      ?
?  ?                 ?              ?                      ?      ?
?  ?  Program.cs:    ?              ?  Program.cs:         ?      ?
?  ?  builder        ?              ?  builder             ?      ?
?  ?   .Services     ?              ?   .Services          ?      ?
?  ?   .AddAI        ?              ?   .AddAI             ?      ?
?  ?   Services()    ?              ?   Services()         ?      ?
?  ???????????????????              ????????????????????????      ?
?           ?                                  ?                  ?
?           ????????????????????????????????????                  ?
????????????????????????????????????????????????????????????????????
                            ?
                            ? Calls Extension Method
                            ?
???????????????????????????????????????????????????????????????????
?                        Diquis.AI Module                         ?
?  ????????????????????????????????????????????????????????????  ?
?  ?  ServiceCollectionExtensions.cs                           ?  ?
?  ?  ??????????????????????????????????????????????????????  ?  ?
?  ?  ?  public static IServiceCollection AddAIServices()  ?  ?  ?
?  ?  ?  {                                                  ?  ?  ?
?  ?  ?    // 1. Locate appsettings.AI.json from assembly ?  ?  ?
?  ?  ?    var assemblyPath = Assembly                     ?  ?  ?
?  ?  ?        .GetExecutingAssembly().Location;           ?  ?  ?
?  ?  ?                                                     ?  ?  ?
?  ?  ?    // 2. Load configuration automatically          ?  ?  ?
?  ?  ?    configBuilder.AddJsonFile(aiConfigPath);        ?  ?  ?
?  ?  ?                                                     ?  ?  ?
?  ?  ?    // 3. Bind to AIConfiguration                   ?  ?  ?
?  ?  ?    services.Configure<AIConfiguration>(...);       ?  ?  ?
?  ?  ?                                                     ?  ?  ?
?  ?  ?    // 4. Register AI services                      ?  ?  ?
?  ?  ?    services.AddScoped<IAIGenerationService>(...);  ?  ?  ?
?  ?  ?    services.AddScoped<IPromptService>(...);        ?  ?  ?
?  ?  ?  }                                                  ?  ?  ?
?  ?  ??????????????????????????????????????????????????????  ?  ?
?  ????????????????????????????????????????????????????????????  ?
?                           ? Loads                               ?
?  ????????????????????????????????????????????????????????????  ?
?  ?            appsettings.AI.json                            ?  ?
?  ?  {                                                        ?  ?
?  ?    "AI": {                                                ?  ?
?  ?      "OllamaBaseUrl": "http://localhost:11434",          ?  ?
?  ?      "DefaultModel": "llama2",                            ?  ?
?  ?      "Prompts": {                                         ?  ?
?  ?        "CleanArchitecture": {                             ?  ?
?  ?          "SystemPrompt": "You are an expert...",          ?  ?
?  ?          "UserPrompt": "Explain Clean Architecture...",   ?  ?
?  ?          "Temperature": 0.7,                              ?  ?
?  ?          "MaxTokens": 500                                 ?  ?
?  ?        },                                                 ?  ?
?  ?        "PlayerChurnPrediction": { ... },                  ?  ?
?  ?        "TrainingSessionPlan": { ... }                     ?  ?
?  ?      }                                                    ?  ?
?  ?    }                                                      ?  ?
?  ?  }                                                        ?  ?
?  ?????????????????????????????????????????????????????????????  ?
?                                                                 ?
?  ????????????????????????????????????????????????????????????? ?
?  ?               Registered Services                         ? ?
?  ?                                                           ? ?
?  ?  • IAIGenerationService ? OllamaService                  ? ?
?  ?  • IPromptService ? PromptService                        ? ?
?  ?  • AIConfiguration (with all prompts)                    ? ?
?  ?  • Background Jobs (TestOllamaJob, etc.)                 ? ?
?  ?  • HttpClient (with retry policies)                      ? ?
?  ????????????????????????????????????????????????????????????? ?
???????????????????????????????????????????????????????????????????
```

## Configuration Flow

```
????????????????????
?  Application     ?
?  Startup         ?
????????????????????
         ?
         ? 1. Call AddAIServices()
         ?
??????????????????????????????????????????
?  Diquis.AI Extension Method            ?
?                                        ?
?  ???????????????????????????????????? ?
?  ? Locate Assembly Directory        ? ?
?  ? var dir = Path.GetDirectoryName( ? ?
?  ?   Assembly.GetExecutingAssembly()? ?
?  ?          .Location);             ? ?
?  ???????????????????????????????????? ?
?                 ?                      ?
?                 ? 2. Find config file  ?
?                 ?                      ?
?  ???????????????????????????????????? ?
?  ? Build Configuration              ? ?
?  ? var path = Path.Combine(         ? ?
?  ?   dir, "appsettings.AI.json");  ? ?
?  ? configBuilder.AddJsonFile(path); ? ?
?  ???????????????????????????????????? ?
?                 ?                      ?
?                 ? 3. Load JSON         ?
?                 ?                      ?
?  ???????????????????????????????????? ?
?  ? Bind to AIConfiguration          ? ?
?  ? services.Configure<AIConfig>(    ? ?
?  ?   options => { ... });           ? ?
?  ???????????????????????????????????? ?
?                 ?                      ?
?                 ? 4. Register Services ?
?                 ?                      ?
?  ???????????????????????????????????? ?
?  ? Register All AI Services         ? ?
?  ? • OllamaService                  ? ?
?  ? • PromptService                  ? ?
?  ? • Background Jobs                ? ?
?  ? • HttpClient                     ? ?
?  ???????????????????????????????????? ?
??????????????????????????????????????????
         ?
         ? 5. Return configured services
         ?
????????????????????
?  Application     ?
?  Running         ?
????????????????????
```

## Prompt Usage Flow

```
???????????????????????????
?  Controller/Job         ?
?  needs to generate AI   ?
?  content                ?
???????????????????????????
           ?
           ? 1. Inject IPromptService
           ?
??????????????????????????????????????????
?  Service Constructor                   ?
?                                        ?
?  public MyService(                     ?
?    IPromptService promptService,       ?
?    IAIGenerationService aiService)     ?
?  {                                     ?
?    _promptService = promptService;     ?
?    _aiService = aiService;             ?
?  }                                     ?
??????????????????????????????????????????
           ?
           ? 2. Prepare variables
           ?
??????????????????????????????????????????
?  var variables = new Dictionary        ?
?  {                                     ?
?    { "playerName", "Alex" },           ?
?    { "parentName", "John Smith" }      ?
?  };                                    ?
??????????????????????????????????????????
           ?
           ? 3. Render prompt
           ?
??????????????????????????????????????????
?  var (systemPrompt, userPrompt) =      ?
?    _promptService.RenderPrompt(        ?
?      "PlayerChurnPrediction",          ?
?      variables);                       ?
??????????????????????????????????????????
           ?
           ? 4. PromptService loads from config
           ?
??????????????????????????????????????????
?  AIConfiguration.Prompts               ?
?  ["PlayerChurnPrediction"]             ?
?  {                                     ?
?    SystemPrompt: "You are...",         ?
?    UserPrompt: "Generate for           ?
?      {{playerName}}...",               ?
?    Temperature: 0.8                    ?
?  }                                     ?
??????????????????????????????????????????
           ?
           ? 5. Replace {{variables}}
           ?
??????????????????????????????????????????
?  systemPrompt = "You are..."           ?
?  userPrompt = "Generate for Alex..."   ?
??????????????????????????????????????????
           ?
           ? 6. Call AI service
           ?
??????????????????????????????????????????
?  var request = new AIGenerationRequest ?
?  {                                     ?
?    ModelName = "llama2",               ?
?    Prompt = userPrompt,                ?
?    SystemPrompt = systemPrompt,        ?
?    Temperature = template.Temperature  ?
?  };                                    ?
?                                        ?
?  var response =                        ?
?    await _aiService.GenerateAsync(     ?
?      request);                         ?
??????????????????????????????????????????
           ?
           ? 7. Return generated text
           ?
???????????????????????????
?  AI Generated Content   ?
?  ready for use          ?
???????????????????????????
```

## File Structure

```
Diquis.AI/
??? appsettings.AI.json ? Configuration lives here
??? Diquis.AI.csproj    ? Configured to copy to output
??? Extensions/
?   ??? ServiceCollectionExtensions.cs ? Auto-loads config
??? Services/
    ??? OllamaService.cs
    ??? PromptService.cs (lives in Application layer)

Diquis.Application/
??? Common/
    ??? AI/
        ??? AIConfiguration.cs    ? Configuration classes
        ??? PromptService.cs      ? Prompt rendering
        ??? IAIGenerationService.cs
        ??? ... (other AI interfaces)

Diquis.WebApi/
??? Program.cs
    ??? builder.Services.AddAIServices(config) ? Simple call

Diquis.BackgroundJobs/
??? Program.cs
    ??? builder.Services.AddAIServices(config) ? Simple call
```

## Build Output

```
When you build the solution:

Diquis.AI/bin/Debug/net10.0/
??? Diquis.AI.dll
??? appsettings.AI.json ? Copied automatically
??? ... (other dependencies)

Diquis.WebApi/bin/Debug/net10.0/
??? Diquis.WebApi.dll
??? Diquis.AI.dll
??? appsettings.AI.json ? From Diquis.AI
??? ... (other files)

Diquis.BackgroundJobs/bin/Debug/net10.0/
??? Diquis.BackgroundJobs.dll
??? Diquis.AI.dll
??? appsettings.AI.json ? From Diquis.AI
??? ... (other files)
```

## Key Design Decisions

1. **Configuration Ownership**: `Diquis.AI` owns `appsettings.AI.json`
2. **Automatic Loading**: Extension method loads config from assembly directory
3. **No Manual Setup**: Consumers just call `AddAIServices()`
4. **Override Support**: Consumers can override in their own appsettings.json
5. **Copy to Output**: MSBuild ensures config file is available at runtime

## Benefits Summary

```
???????????????????????????????????????????????????????????????
?              Before (Scattered)      After (Self-Contained) ?
???????????????????????????????????????????????????????????????
?  Configuration   WebApi project      AI project            ?
?  Loading         Manual              Automatic             ?
?  Consumer Setup  2 steps             1 step                ?
?  Portability     Dependent           Independent           ?
?  Maintenance     Multiple files      Single source         ?
?  Clarity         ? Unclear          ? Clear ownership   ?
???????????????????????????????????????????????????????????????
```
